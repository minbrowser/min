/*! 11-15-2015 */
function extractColor(a,b){var c=document.createElement("img");c.src=a,c.onload=function(){b(cf.getColor(c))}}function updateTabColor(a,b){return 1==tabs.get(b)["private"]?(tabs.update(b,{backgroundColor:"#3a2c63",foregroundColor:"white"}),void(b==tabs.getSelected()&&setColor("#3a2c63","white"))):void extractColor(a[0],function(a){var c="rgb("+a[0]+","+a[1]+","+a[2]+")",d={r:a[0]/255,g:a[1]/255,b:a[2]/255},e=getTextColor(d);console.log(d,e),tabs.update(b,{backgroundColor:c,foregroundColor:e}),b==tabs.getSelected()&&setColor(c,e)})}function setColor(a,b){$(".theme-background-color").css("background-color",a),$(".theme-text-color").css("color",b),"white"==b?$(document.body).addClass("dark-theme"):$(document.body).removeClass("dark-theme")}function navigate(a,b){console.trace(),console.log("navigated"),tabs.update(a,{url:b}),updateWebview(a,b),leaveTabEditMode({blur:!0})}function destroyTab(a){var b=tabs.getIndex(a),c=tabs.getAtIndex(b+1)||tabs.getAtIndex(b-1);$(".tab-item[data-tab={id}]".replace("{id}",a)).remove();var b=tabs.destroy(a);return destroyWebview(a),console.log(b),console.log(c),c?void switchToTab(c.id):addTab()}function switchToTab(a){leaveTabEditMode(),tabs.setSelected(a),switchToWebview(a),setActiveTabElement(a);var b=tabs.get(a);setColor(b.backgroundColor,b.foregroundColor),tabs.update(a,{lastActivity:(new Date).getTime()}),tabActivity.refresh()}function unsafe_showColorUI(a,b){var c=$("<div>").html(b),d=c.find(".colorcodesbox.circle").css("background"),e=[];c.find(".no_vspace").each(function(){e.push($(this).text())});var f=$("<div class='result-item' tabindex='-1'>");return f.text(a),$("<div class='result-icon color-circle'>").css("background",d).prependTo(f),$("<span class='description-block'>").text(e.join(" "+METADATA_SEPARATOR+" ")).appendTo(f),f}function throttle(a,b,c){b||(b=250);var d,e;return function(){var f=c||this,g=+new Date,h=arguments;d&&d+b>g?(clearTimeout(e),e=setTimeout(function(){d=g,a.apply(f,h)},b)):(d=g,a.apply(f,h))}}function removeTags(a){return a.replace(/<[\w\W]*>/g,"")}function unsafeUnwrapTags(a){return $("<div>").html(a).text()}function parseAwesomebarUrl(a){return 0==a.indexOf("?")&&(a=urlParser.searchBaseURL.replace("%s",encodeURIComponent(a.replace("?","")))),0==a.indexOf("^")&&(a=a.replace("^","")),0==a.indexOf("*")&&(a=a.replace("*","")),a}function openURLInBackground(a){var b=tabs.add({url:a,"private":tabs.get(tabs.getSelected())["private"]});addTab(b,{focus:!1,openInBackground:!0,leaveEditMode:!1}),$(".result-item:focus").blur()}function clearAwesomebar(){historyarea.html(""),bookmarkarea.html(""),serarea.html(""),iaarea.html(""),topicsarea.html(""),opentabarea.html(""),suggestedsitearea.html("")}function showAwesomebar(a){awesomebarCachedText=a.val(),awesomebarShown=!0,$(document.body).addClass("awesomebar-shown"),clearAwesomebar(),awesomebar.show();tabs.get(tabs.getSelected())}function hideAwesomebar(){awesomebarShown=!1,$(document.body).removeClass("awesomebar-shown"),awesomebar.hide(),cachedBangSnippets={}}function focusAwesomebarItem(a){a=a||{};var b=a.focusPrevious,c=$("#awesomebar .result-item:not(.unfocusable)"),d=$("#awesomebar .result-item:focus"),e=c.index(d),f=c.eq(b?e-1:e+1);d[0]&&f[0]?f.get(0).focus():$("#awesomebar .result-item").first().get(0).focus()}function updateURLInternal(a,b){console.log("setting url to "+b),a.attr("src",b)}function getWebviewDom(a){var b=(a||{}).url||"about:blank",c=$("<webview>");return c.attr("preload","dist/webview.min.js"),c.attr("src",urlParser.parse(b)),c.attr("data-tab",a.tabId),1==tabs.get(a.tabId)["private"]&&c.attr("partition",a.tabId),c.on("page-favicon-updated",function(a){var b=$(this).attr("data-tab");updateTabColor(a.originalEvent.favicons,b)}),c.on("page-title-set",function(a){var b=$(this).attr("data-tab");tabs.update(b,{title:a.originalEvent.title}),rerenderTabElement(b)}),c.on("did-finish-load",function(a){var b=$(this).attr("data-tab"),c=a.target.getUrl();0===c.indexOf("https://")?tabs.update(b,{secure:!0,url:c}):tabs.update(b,{secure:!1,url:c}),7==c.indexOf(__dirname+"/reader/index.html")?tabs.update(b,{isReaderView:!0}):tabs.update(b,{isReaderView:!1}),tabs.update(b,{readerable:!1}),readerView.updateButton(b),0==tabs.get(b)["private"]&&bookmarks.updateHistory(b),rerenderTabElement(b)}),c.on("did-get-redirect-request",function(a){}),c.on("new-window",function(a){var b=$(this).attr("data-tab"),c=tabs.add({url:a.originalEvent.url,"private":tabs.get(b)["private"]});addTab(c,{focus:!1,openInBackground:"background-tab"==a.originalEvent.disposition})}),c.on("ipc-message",function(a){var b=$(this).attr("data-tab");"bookmarksData"==a.originalEvent.channel?bookmarks.onDataRecieved(a.originalEvent.args[0]):"canReader"==a.originalEvent.channel?(tabs.update(b,{readerable:!0}),readerView.updateButton(b)):"contextData"==a.originalEvent.channel?webviewMenu.loadFromContextData(a.originalEvent.args[0]):"phishingDetected"==a.originalEvent.channel&&navigate($(this).attr("data-tab"),phishingWarningPage)}),c.on("contextmenu",webviewMenu.show),c}function addWebview(a,b){b=b||{};var c=tabs.get(a),d=getWebviewDom({tabId:a,url:c.url});webviewBase.append(d),b.openInBackground?d.addClass("hidden"):switchToWebview(a)}function switchToWebview(a){$("webview").hide(),$("webview[data-tab={id}]".replace("{id}",a)).removeClass("hidden").show().get(0).focus()}function updateWebview(a,b){var c=$("webview[data-tab={id}]".replace("{id}",a));c.attr("src",urlParser.parse(b))}function destroyWebview(a){$("webview[data-tab={id}]".replace("{id}",a)).remove()}function getWebview(a){return $("webview[data-tab={id}]".replace("{id}",a))}function getTabElement(a){return $(".tab-item[data-tab={id}]".replace("{id}",a))}function setActiveTabElement(a){$(".tab-item").removeClass("active");var b=getTabElement(a);b.addClass("active"),tabs.count()>1?b.addClass("has-highlight"):b.removeClass("has-highlight"),b[0].scrollIntoView({behavior:"smooth"})}function leaveTabEditMode(a){$(".tab-item").removeClass("selected"),a&&a.blur&&$(".tab-item .tab-input").blur(),tabGroup.removeClass("has-selected-tab"),hideAwesomebar()}function enterEditMode(a){var b=getTabElement(a),c=getWebview(a)[0];try{var d=c.getUrl()}catch(e){console.warn("failed to get webview URL");var d=null}var f=b.getInput();b.addClass("selected"),f.focus().val(d).select(),showAwesomebar(f),tabGroup.addClass("has-selected-tab")}function rerenderTabElement(a){console.log(a);var b=getTabElement(a),c=tabs.get(a);b.find(".tab-view-contents .title").text(c.title||"New Tab"),b.find(".tab-view-contents .icon-tab-is-secure, .icon-tab-is-private").remove(),c.secure&&b.find(".tab-view-contents").prepend("<i class='fa fa-lock icon-tab-is-secure'></i>"),c["private"]&&b.find(".tab-view-contents").prepend("<i class='fa fa-ban icon-tab-is-private'></i>").attr("title","Private tab"),bookmarks.renderStar(a,b.find(".bookmarks-button"))}function createTabElement(a){console.log(a);var b=tabs.get(a),c="Search or enter address",d=urlParser.parse(b.url),e=$("<div class='tab-item'>");e.attr("data-tab",a),b["private"]&&e.addClass("private-tab");var f=$("<input class='tab-input theme-text-color mousetrap'>");f.attr("placeholder",c),f.attr("value",d);var g=$("<div class='tab-edit-contents'>");f.appendTo(g),bookmarks.getStar(a).appendTo(g),g.appendTo(e);var h=$("<div class='tab-view-contents theme-text-color'>");return readerView.getButton(a).appendTo(h),h.append($("<span class='title'>").text(b.title||"")),h.appendTo(e),e.on("click",function(a){var b=$(this).attr("data-tab");tabs.getSelected()!=b?($(".tab-input").blur(),switchToTab(b)):enterEditMode(b)}),f.on("keydown",function(a){(9==a.keyCode||40==a.keyCode)&&(focusAwesomebarItem(),a.preventDefault())}),f.on("keyup",function(a){if(13==a.keyCode){var b=$(this).parents(".tab-item").attr("data-tab"),c=parseAwesomebarUrl($(this).val());navigate(b,c),switchToTab(b)}else 9==a.keyCode||showAwesomebarResults(f.val(),f,a.keyCode)}),f.on("click",function(a){a.stopPropagation()}),e}function addTab(a,b){b=b||{},0!=b.leaveEditMode&&leaveTabEditMode(),a=a||tabs.add({backgroundColor:"rgb(255, 255, 255)",foregroundColor:"black"}),tabGroup.append(createTabElement(a)),addWebview(a,{openInBackground:b.openInBackground}),b.openInBackground||(switchToTab(a),0!=b.focus&&enterEditMode(a))}var bookmarks={authBookmarkTab:null,updateHistory:function(a){var b=getWebview(a)[0],c={url:b.getUrl(),title:b.getTitle(),color:tabs.get(a).backgroundColor};bookmarks.worker.postMessage({action:"updateHistory",data:c})},currentCallback:function(){},onDataRecieved:function(a){if(!bookmarks.authBookmarkTab||getWebview(bookmarks.authBookmarkTab)[0].getUrl()!=a.url)throw new Error("Bookmark operation is unauthoritized.");a.title=getWebview(bookmarks.authBookmarkTab)[0].getTitle(),bookmarks.worker.postMessage({action:"addBookmark",data:a}),bookmarks.authBookmarkTab=null},"delete":function(a){bookmarks.worker.postMessage({action:"deleteBookmark",data:{url:a}})},search:function(a,b){bookmarks.currentCallback=b,bookmarks.worker.postMessage({action:"searchBookmarks",text:a})},searchHistory:function(a,b){bookmarks.currentHistoryCallback=b,bookmarks.worker.postMessage({action:"searchHistory",text:a})},searchTopics:function(a,b){bookmarks.currentTopicsCallback=b,bookmarks.worker.postMessage({action:"searchTopics",text:a})},onMessage:function(a){"bookmarks"==a.data.scope?bookmarks.currentCallback(a.data.result):"history"==a.data.scope?bookmarks.currentHistoryCallback(a.data.result):"topics"==a.data.scope&&bookmarks.currentTopicsCallback(a.data.result)},bookmark:function(a){bookmarks.authBookmarkTab=a,getWebview(a)[0].send("sendData")},toggleBookmarked:function(a){var b=tabs.get(a).url,c=!1;bookmarks.search(b,function(d){d.forEach(function(a){a.url==b&&(c=!0)}),c?(console.log("deleting bookmark "+tabs.get(a).url),bookmarks["delete"](tabs.get(a).url)):bookmarks.bookmark(a)})},getStar:function(a){var b=$("<i class='fa fa-star-o bookmarks-button theme-text-color'>").attr("data-tab",a);return b.on("click",function(a){$(this).toggleClass("fa-star").toggleClass("fa-star-o"),bookmarks.toggleBookmarked($(this).attr("data-tab"))}),bookmarks.renderStar(a,b)},renderStar:function(a,b){b=b||$(".bookmarks-button[data-tab={id}]".replace("{id}",a));try{var c=getWebview(a)[0].getUrl()}catch(d){var c=tabs.get(a).url}return c&&"about:blank"!=c?b.prop("hidden",!1):b.prop("hidden",!0),bookmarks.search(c,function(a){a&&a[0]&&a[0].url==c?b.removeClass("fa-star-o").addClass("fa-star"):b.removeClass("fa-star").addClass("fa-star-o")}),b},init:function(){bookmarks.worker=new Worker("js/historyworker.js"),bookmarks.worker.onmessage=bookmarks.onMessage}};bookmarks.init();var CanvasImage=function(a){this.canvas=document.createElement("canvas"),this.context=this.canvas.getContext("2d"),document.body.appendChild(this.canvas),this.width=this.canvas.width=a.width,this.height=this.canvas.height=a.height,this.context.drawImage(a,0,0,this.width,this.height)};CanvasImage.prototype.clear=function(){this.context.clearRect(0,0,this.width,this.height)},CanvasImage.prototype.update=function(a){this.context.putImageData(a,0,0)},CanvasImage.prototype.getPixelCount=function(){return this.width*this.height},CanvasImage.prototype.getImageData=function(){return this.context.getImageData(0,0,this.width,this.height)},CanvasImage.prototype.removeCanvas=function(){this.canvas.parentNode.removeChild(this.canvas)};var ColorThief=function(){};if(ColorThief.prototype.getColor=function(a,b){var c=this.getPalette(a,5,b),d=c[0];return d},ColorThief.prototype.getPalette=function(a,b,c){"undefined"==typeof b&&(b=10),("undefined"==typeof c||1>c)&&(c=10);for(var d,e,f,g,h,i=new CanvasImage(a),j=i.getImageData(),k=j.data,l=i.getPixelCount(),m=[],n=0;l>n;n+=c)d=4*n,e=k[d+0],f=k[d+1],g=k[d+2],h=k[d+3],h>=125&&(e>250&&f>250&&g>250||m.push([e,f,g]));var o=MMCQ.quantize(m,b),p=o?o.palette():null;return i.removeCanvas(),p},!pv)var pv={map:function(a,b){var c={};return b?a.map(function(a,d){return c.index=d,b.call(c,a)}):a.slice()},naturalOrder:function(a,b){return b>a?-1:a>b?1:0},sum:function(a,b){var c={};return a.reduce(b?function(a,d,e){return c.index=e,a+b.call(c,d)}:function(a,b){return a+b},0)},max:function(a,b){return Math.max.apply(null,b?pv.map(a,b):a)}};var MMCQ=function(){function a(a,b,c){return(a<<2*i)+(b<<i)+c}function b(a){function b(){c.sort(a),d=!0}var c=[],d=!1;return{push:function(a){c.push(a),d=!1},peek:function(a){return d||b(),void 0===a&&(a=c.length-1),c[a]},pop:function(){return d||b(),c.pop()},size:function(){return c.length},map:function(a){return c.map(a)},debug:function(){return d||b(),c}}}function c(a,b,c,d,e,f,g){var h=this;h.r1=a,h.r2=b,h.g1=c,h.g2=d,h.b1=e,h.b2=f,h.histo=g}function d(){this.vboxes=new b(function(a,b){return pv.naturalOrder(a.vbox.count()*a.vbox.volume(),b.vbox.count()*b.vbox.volume())})}function e(b){var c,d,e,f,g=1<<3*i,h=new Array(g);return b.forEach(function(b){d=b[0]>>j,e=b[1]>>j,f=b[2]>>j,c=a(d,e,f),h[c]=(h[c]||0)+1}),h}function f(a,b){var d,e,f,g=1e6,h=0,i=1e6,k=0,l=1e6,m=0;return a.forEach(function(a){d=a[0]>>j,e=a[1]>>j,f=a[2]>>j,g>d?g=d:d>h&&(h=d),i>e?i=e:e>k&&(k=e),l>f?l=f:f>m&&(m=f)}),new c(g,h,i,k,l,m,b)}function g(b,c){function d(a){var b,d,e,f,g,h=a+"1",j=a+"2",k=0;for(i=c[h];i<=c[j];i++)if(o[i]>n/2){for(e=c.copy(),f=c.copy(),b=i-c[h],d=c[j]-i,g=d>=b?Math.min(c[j]-1,~~(i+d/2)):Math.max(c[h],~~(i-1-b/2));!o[g];)g++;for(k=p[g];!k&&o[g-1];)k=p[--g];return e[j]=g,f[h]=e[j]+1,[e,f]}}if(c.count()){var e=c.r2-c.r1+1,f=c.g2-c.g1+1,g=c.b2-c.b1+1,h=pv.max([e,f,g]);if(1==c.count())return[c.copy()];var i,j,k,l,m,n=0,o=[],p=[];if(h==e)for(i=c.r1;i<=c.r2;i++){for(l=0,j=c.g1;j<=c.g2;j++)for(k=c.b1;k<=c.b2;k++)m=a(i,j,k),l+=b[m]||0;n+=l,o[i]=n}else if(h==f)for(i=c.g1;i<=c.g2;i++){for(l=0,j=c.r1;j<=c.r2;j++)for(k=c.b1;k<=c.b2;k++)m=a(j,i,k),l+=b[m]||0;n+=l,o[i]=n}else for(i=c.b1;i<=c.b2;i++){for(l=0,j=c.r1;j<=c.r2;j++)for(k=c.g1;k<=c.g2;k++)m=a(j,k,i),l+=b[m]||0;n+=l,o[i]=n}return o.forEach(function(a,b){p[b]=n-a}),d(h==e?"r":h==f?"g":"b")}}function h(a,c){function h(a,b){for(var c,d=1,e=0;k>e;)if(c=a.pop(),c.count()){var f=g(i,c),h=f[0],j=f[1];if(!h)return;if(a.push(h),j&&(a.push(j),d++),d>=b)return;if(e++>k)return}else a.push(c),e++}if(!a.length||2>c||c>256)return!1;var i=e(a),j=0;i.forEach(function(){j++});var m=f(a,i),n=new b(function(a,b){return pv.naturalOrder(a.count(),b.count())});n.push(m),h(n,l*c);for(var o=new b(function(a,b){return pv.naturalOrder(a.count()*a.volume(),b.count()*b.volume())});n.size();)o.push(n.pop());h(o,c-o.size());for(var p=new d;o.size();)p.push(o.pop());return p}var i=5,j=8-i,k=1e3,l=.75;return c.prototype={volume:function(a){var b=this;return(!b._volume||a)&&(b._volume=(b.r2-b.r1+1)*(b.g2-b.g1+1)*(b.b2-b.b1+1)),b._volume},count:function(b){var c=this,d=c.histo;if(!c._count_set||b){var e,f,g,h=0;for(e=c.r1;e<=c.r2;e++)for(f=c.g1;f<=c.g2;f++)for(g=c.b1;g<=c.b2;g++)index=a(e,f,g),h+=d[index]||0;c._count=h,c._count_set=!0}return c._count},copy:function(){var a=this;return new c(a.r1,a.r2,a.g1,a.g2,a.b1,a.b2,a.histo)},avg:function(b){var c=this,d=c.histo;if(!c._avg||b){var e,f,g,h,j,k=0,l=1<<8-i,m=0,n=0,o=0;for(f=c.r1;f<=c.r2;f++)for(g=c.g1;g<=c.g2;g++)for(h=c.b1;h<=c.b2;h++)j=a(f,g,h),e=d[j]||0,k+=e,m+=e*(f+.5)*l,n+=e*(g+.5)*l,o+=e*(h+.5)*l;k?c._avg=[~~(m/k),~~(n/k),~~(o/k)]:c._avg=[~~(l*(c.r1+c.r2+1)/2),~~(l*(c.g1+c.g2+1)/2),~~(l*(c.b1+c.b2+1)/2)]}return c._avg},contains:function(a){var b=this,c=a[0]>>j;return gval=a[1]>>j,bval=a[2]>>j,c>=b.r1&&c<=b.r2&&gval>=b.g1&&gval<=b.g2&&bval>=b.b1&&bval<=b.b2}},d.prototype={push:function(a){this.vboxes.push({vbox:a,color:a.avg()})},palette:function(){return this.vboxes.map(function(a){return a.color})},size:function(){return this.vboxes.size()},map:function(a){for(var b=this.vboxes,c=0;c<b.size();c++)if(b.peek(c).vbox.contains(a))return b.peek(c).color;return this.nearest(a)},nearest:function(a){for(var b,c,d,e=this.vboxes,f=0;f<e.size();f++)c=Math.sqrt(Math.pow(a[0]-e.peek(f).color[0],2)+Math.pow(a[1]-e.peek(f).color[1],2)+Math.pow(a[2]-e.peek(f).color[2],2)),(b>c||void 0===b)&&(b=c,d=e.peek(f).color);return d},forcebw:function(){var a=this.vboxes;a.sort(function(a,b){return pv.naturalOrder(pv.sum(a.color),pv.sum(b.color))});var b=a[0].color;b[0]<5&&b[1]<5&&b[2]<5&&(a[0].color=[0,0,0]);var c=a.length-1,d=a[c].color;d[0]>251&&d[1]>251&&d[2]>251&&(a[c].color=[255,255,255])}},{quantize:h}}(),urlParser={searchBaseURL:"https://duckduckgo.com/?q=%s",isUrl:function(a){return 0==a.indexOf("http://")||0==a.indexOf("https://")||0==a.indexOf("file://")||0==a.indexOf("about:")||0==a.indexOf("chrome:")||0==a.indexOf("data:")},isSystemURL:function(a){return 0==a.indexOf("chrome")||0==a.indexOf("about:")},removeProtocol:function(a){if(!urlParser.isUrl(a))return a;var b=a.replace("http://","").replace("https://","").replace("file://","");if(0==b.indexOf("www."))var c=b.replace("www.","");else var c=b;return c},isUrlMissingProtocol:function(a){return-1==a.indexOf(" ")&&a.indexOf(".")>0},parse:function(a){return a=a.trim(),a?urlParser.isUrl(a)?a:urlParser.isUrlMissingProtocol(a)?"http://"+a:urlParser.searchBaseURL.replace("%s",encodeURIComponent(a)):""}},cf=new ColorThief,getTextColor=function(a){var b=runNetwork(a);return b.black>.5?"black":"white"},runNetwork=function(a){for(var b={layers:[{r:{},g:{},b:{}},{0:{bias:23.754294528362333,weights:{r:-9.164071534408635,g:-23.39042212583149,b:-6.141882230115919}},1:{bias:1.0246367545353685,weights:{r:.1979499996014915,g:-12.323452468849514,b:18.23294673275185}},2:{bias:12.375896556781662,weights:{r:-7.113624260920017,g:-2.010919862284879,b:-11.041419679013966}}},{black:{bias:20.134564019110876,weights:{0:-19.035591267853714,1:-11.208318873932066,2:-10.439005826172572}}}],outputLookup:!0,inputLookup:!0},c=1;c<b.layers.length;c++){var d=b.layers[c],e={};for(var f in d){var g=d[f],h=g.bias;for(var i in g.weights)h+=g.weights[i]*a[i];e[f]=1/(1+Math.exp(-h))}a=e}return e},remote=require("remote"),Menu=remote.require("menu"),MenuItem=remote.require("menu-item"),clipboard=require("clipboard"),webviewMenu={cache:{event:null,webview:null},loadFromContextData:function(a){var b=tabs.get(tabs.getSelected()),c=webviewMenu.cache.event,d=new Menu;a.src&&(d.append(new MenuItem({label:"Open in New Tab",click:function(){var c=tabs.add({url:a.src,"private":b["private"]});addTab(c,{focus:!1})}})),b["private"]||d.append(new MenuItem({label:"Open in New Private Tab",click:function(){var b=tabs.add({url:a.src,"private":!0});addTab(b,{focus:!1})}})),d.append(new MenuItem({type:"separator"})),d.append(new MenuItem({label:"Copy link",click:function(){clipboard.writeText(a.src)}}))),a.selection&&(d.append(new MenuItem({label:"Copy",click:function(){clipboard.writeText(a.selection)}})),d.append(new MenuItem({type:"separator"})),d.append(new MenuItem({label:"Search with DuckDuckGo",click:function(){var c=tabs.add({url:"https://duckduckgo.com/?q="+encodeURIComponent(a.selection),"private":b["private"]});addTab(c,{focus:!1})}}))),a.image&&d.append(new MenuItem({label:"View image",click:function(){navigate(webviewMenu.cache.tab,a.image)}})),d.append(new MenuItem({label:"Inspect Element",click:function(){webviewMenu.cache.webview.inspectElement(c.x,c.y)}})),d.popup(remote.getCurrentWindow())},show:function(a){var b=a.originalEvent||a;webviewMenu.cache.event=b,console.log(b);var c=tabs.getSelected(),d=getWebview(c)[0];webviewMenu.cache.tab=c,webviewMenu.cache.webview=d,d.send("getContextData",{x:b.offsetX,y:b.offsetY})}},DDGSearchUrlRegex=/^https:\/\/duckduckgo.com\/\?q=([^&]*).*/g,plusRegex=/\+/g,trailingSlashRegex=/\/$/g,showHistoryResults=function(a,b,c){if(a){var d=b[0];bookmarks.searchHistory(a,function(a){historyarea.html(""),limitSearchSuggestions(a.length),a.forEach(function(a,e){var f=!1,g=a.title,h=$("<i class='fa fa-globe'>");DDGSearchUrlRegex.lastIndex=0,DDGSearchUrlRegex.test(a.url)&&(g=decodeURIComponent(a.url.replace(DDGSearchUrlRegex,"$1").replace(plusRegex," ")),h=$("<i class='fa fa-search'>"),f=!0);var i=b.val(),j=urlParser.removeProtocol(i),k=urlParser.removeProtocol(a.url);if(j!=i)var l=!0;var m=-1!=i.indexOf("www.");if(-1==j.indexOf("/"))var n=!1;else var n=!0;if(shouldContinueAC&&0==cachedACItem.indexOf(i)&&(b.blur(),d.value=cachedACItem,d.setSelectionRange(i.length,cachedACItem.length),b.focus(),awesomebarCachedText=b.val(),shouldContinueAC=!1),autocompleteEnabled&&shouldContinueAC&&j&&(0==k.indexOf(j)||f&&0==g.indexOf(j))){if(f)var o=g;else{var p=m?a.url:a.url.replace("www.",""),o=l?p:k;if(!n&&!urlParser.isSystemURL(p)){var q=document.createElement("a");q.href=p,o=(l?q.protocol+"//":"")+q.hostname}}if(!o)return;b.blur(),d.value=o,d.setSelectionRange(i.length,o.length),b.focus(),awesomebarCachedText=d.value,shouldContinueAC=!1,cachedACItem=o}if(c>e){var r=$("<div class='result-item' tabindex='-1'>").append($("<span class='title'>").text(g)).on("click",function(b){b.metaKey?openURLInBackground(a.url):navigate(tabs.getSelected(),a.url)});h.prependTo(r),$("<span class='secondary-text'>").text(urlParser.removeProtocol(a.url).replace(trailingSlashRegex,"")).appendTo(r),r.appendTo(historyarea)}})})}},showBookmarkResults=throttle(function(a){a&&bookmarks.search(a,function(a){bookmarkarea.html(""),a.splice(0,2).forEach(function(a){if(a.score>47e-5){var b=$("<div class='result-item' tabindex='-1'>").append($("<span class='title'>").text(a.title)).on("click",function(b){b.metaKey?openURLInBackground(a.url):navigate(tabs.getSelected(),a.url)});$("<i class='fa fa-star'>").prependTo(b);var c=$("<span class='secondary-text'>").text(urlParser.removeProtocol(a.url).replace(trailingSlashRegex,""));if(a.extraData&&a.extraData.metadata){var d=[];a.extraData.metadata.rating&&d.push($("<span class='md-info'>").text(a.extraData.metadata.rating)),a.extraData.metadata.price&&d.push($("<span class='md-info'>").text(a.extraData.metadata.price)),a.extraData.metadata.location&&d.push($("<span class='md-info'>").text(a.extraData.metadata.location)),d.reverse().forEach(function(a){c.prepend(a)})}c.appendTo(b),b.appendTo(bookmarkarea)}})})},400),BANG_REGEX=/!\w+/g,serarea=$("#awesomebar .search-engine-results"),iaarea=$("#awesomebar .instant-answer-results"),suggestedsitearea=$("#awesomebar .ddg-site-results"),maxSearchSuggestions=5;window.showSearchSuggestions=throttle(function(a,b){if(a){if(BANG_REGEX.test(a))var c=a.match(BANG_REGEX)[0],d=cachedBangSnippets[c];$.ajax("https://ac.duckduckgo.com/ac/?q="+encodeURIComponent(a)).done(function(a){serarea.find(".result-item").addClass("old"),a&&a[0]&&a[0].snippet?a.splice(0,5).forEach(function(a){cachedBangSnippets[a.phrase]=a.snippet;var c=$("<div class='result-item' tabindex='-1'>").append($("<span class='title'>").text(a.snippet)).on("click",function(){setTimeout(function(){b.val(a.phrase+" ").focus()},100)});$("<span class='secondary-text'>").text(a.phrase).appendTo(c),$("<img class='result-icon inline'>").attr("src",a.image).prependTo(c),c.appendTo(serarea)}):a&&(a=a.splice(0,maxSearchSuggestions),a.forEach(function(a){var b=a.phrase;if(BANG_REGEX.test(a.phrase)&&d){b=a.phrase.replace(BANG_REGEX,"");var c="Search on "+d}var e=$("<div class='result-item' tabindex='-1'>").append($("<span class='title'>").text(b)).on("click",function(b){b.metaKey?openURLInBackground(a.phrase):navigate(tabs.getSelected(),a.phrase)});e.appendTo(serarea),urlParser.isUrl(a.phrase)||urlParser.isUrlMissingProtocol(a.phrase)?$("<i class='fa fa-globe'>").prependTo(e):$("<i class='fa fa-search'>").prependTo(e),c&&$("<span class='secondary-text'>").text(c).appendTo(e)})),serarea.find(".old").remove()})}},500);var limitSearchSuggestions=function(a){var b=Math.max(3,5-a);maxSearchSuggestions=b,serarea.find(".result-item:nth-child(n+{items})".replace("{items}",b+1)).remove()};window.showInstantAnswers=throttle(function(a,b){urlParser.isUrlMissingProtocol(a)||(iaarea.find(".result-item").addClass("old"),suggestedsitearea.find(".result-item").addClass("old"),a.length>3?$.getJSON("https://api.duckduckgo.com/?skip_disambig=1&format=json&pretty=1&q="+encodeURIComponent(a),function(b){if(iaarea.find(".result-item").addClass("old"),suggestedsitearea.find(".result-item").addClass("old"),b.Abstract||b.Answer){var c=$("<div class='result-item' tabindex='-1'>");b.Answer?c.text(unsafeUnwrapTags(b.Answer)):c.text(b.Heading),b.Image&&"company"!=b.Entity&&"country"!=b.Entity&&"website"!=b.Entity&&$("<img class='result-icon image'>").attr("src",b.Image).prependTo(c),$("<span class='description-block'>").text(removeTags(b.Abstract)||"Answer").appendTo(c),"color_code"==b.AnswerType&&(c=unsafe_showColorUI(a,b.Answer)),c.on("click",function(c){c.metaKey?openURLInBackground(b.AbstractURL||a):navigate(tabs.getSelected(),b.AbstractURL||a)}),c.appendTo(iaarea)}if(b.Results&&b.Results[0]&&b.Results[0].FirstURL){var d=urlParser.removeProtocol(b.Results[0].FirstURL).replace(trailingSlashRegex,""),c=$("<div class='result-item' tabindex='-1'>").append($("<span class='title'>").text(d)).on("click",function(a){a.metaKey?openURLInBackground(b.Results[0].FirstURL):navigate(tabs.getSelected(),b.Results[0].FirstURL)});$("<i class='fa fa-globe'>").prependTo(c),$("<span class='secondary-text'>").text("Suggested site").appendTo(c),console.log(c),c.appendTo(suggestedsitearea)}iaarea.find(".old").remove(),suggestedsitearea.find(".old").remove()}):(iaarea.find(".old").remove(),suggestedsitearea.find(".old").remove()))},700);var showTopicResults=function(a,b){bookmarks.searchTopics(a,function(a){topicsarea.html(""),a&&a[0]&&a.splice(0,4).forEach(function(a){a.name!=b.val()&&$("<div class='result-item tag' tabindex='-1'>").text(a.name).appendTo(topicsarea).on("click",function(c){clearAwesomebar(),b.val(a.name),showHistoryResults(a.name,b,50),setTimeout(function(){b.focus()},800)})})})},spacesRegex=/[\s._/-]/g,searchOpenTabs=function(a){var b=a.toLowerCase().split(spacesRegex),c=[],d=tabs.getSelected();if(opentabarea.html(""),a&&!(a.length<2)){var e=a.length;tabs.get().forEach(function(a){if(a.id!=d&&a.title&&"about:blank"!=a.url){var f=!0,g=urlParser.removeProtocol(a.url);e>3&&(g+=a.title),g=g.toLowerCase().replace(spacesRegex,"").toString();for(var h=0;h<b.length;h++)if(-1==g.indexOf(b[h])){f=!1;break}f&&c.push(a)}}),c.splice(0,2).sort(function(a,b){return a.lastActivity-b.lastActivity}).forEach(function(a){var b=$("<div class='result-item' tabindex='-1'>").append($("<span class='title'>").text(a.title)).on("click",function(){switchToTab(a.id)});$("<i class='fa fa-external-link'>").attr("title","Switch to Tab").prependTo(b),b.appendTo(opentabarea)})}},awesomebarShown=!1,awesomebarCachedText="",cachedACItem="",autocompleteEnabled=!0,shouldContinueAC=!0,METADATA_SEPARATOR="Â·",defaultMaxHistoryResults=3,cachedBangSnippets={},awesomebar=$("#awesomebar"),historyarea=awesomebar.find(".history-results"),bookmarkarea=awesomebar.find(".bookmark-results"),topicsarea=awesomebar.find(".topic-results"),opentabarea=awesomebar.find(".opentab-results"),showAwesomebarResults=throttle(function(a,b,c){if(shouldContinueAC=!(8==c),console.log("awesomebar: ",a),a!=awesomebarCachedText){if(a.length<1)return void clearAwesomebar();if(0==a.indexOf("?"))return clearAwesomebar(),maxSearchSuggestions=5,void showSearchSuggestions(a.replace("?",""),b);if(0==a.indexOf("^"))return clearAwesomebar(),void showHistoryResults(a.replace("^",""),b,5);if(0==a.indexOf("*"))return clearAwesomebar(),void showBookmarkResults(a.replace("*",""),b);showSearchSuggestions(a,b),a.length>3&&showBookmarkResults(a),showHistoryResults(a,b,defaultMaxHistoryResults),showInstantAnswers(a,b),showTopicResults(a,b),searchOpenTabs(a,b),awesomebarCachedText=a}},25);awesomebar.on("keydown",".result-item",function(a){13==a.keyCode?$(this).trigger("click"):9==a.keyCode||40==a.keyCode?(a.preventDefault(),focusAwesomebarItem()):38==a.keyCode&&(a.preventDefault(),focusAwesomebarItem({focusPrevious:!0}))});var phishingWarningPage="file://"+__dirname+"/pages/phishing/index.html",webviewBase=$("#webviews"),WebviewsWithHiddenClass=!1,readerView={getButton:function(a){return $("<i class='fa fa-align-left reader-button'>").attr("data-tab",a).attr("title","Enter reader view")},updateButton:function(a){var b=$(".reader-button[data-tab={id}]".replace("{id}",a)),c=tabs.get(a);return b.off(),c.isReaderView?(b.addClass("is-reader").attr("title","Exit reader view"),void b.on("click",function(b){b.stopPropagation(),readerView.exit(a)})):(b.removeClass("is-reader").attr("title","Enter reader view"),void(c.readerable?(b.addClass("can-reader"),b.on("click",function(b){b.stopPropagation(),readerView.enter(a)})):b.removeClass("can-reader")))},enter:function(a){navigate(a,"file:///"+__dirname+"/reader/index.html?url="+tabs.get(a).url),tabs.update(a,{isReaderView:!0})},exit:function(a){navigate(a,tabs.get(a).url.split("?url=")[1]),tabs.update(a,{isReaderView:!1})}};Array.prototype.remove=function(a,b){var c=this.slice((b||a)+1||this.length);return this.length=0>a?this.length+a:a,this.push.apply(this,c)};var tabs={_state:{tabs:[],selected:null},add:function(a){if(!a)throw new TypeError("tab is not defined.");a.url=a.url||"";var b=a.id||Math.round(1e17*Math.random());return tabs._state.tabs.push({url:a.url,title:a.title,id:b,lastActivity:(new Date).getTime(),secure:!1,"private":a["private"]||!1,readerable:!1,backgroundColor:a.backgroundColor,foregroundColor:a.foregroundColor}),b},update:function(a,b){if(!tabs.get(a))throw new ReferenceError("Attempted to update a tab that does not exist.");for(var c=-1,d=0;d<tabs._state.tabs.length;d++)tabs._state.tabs[d].id==a&&(c=d);for(var e in b){if(void 0==b[e])throw new ReferenceError("Key "+e+" is undefined.");tabs._state.tabs[c][e]=b[e]}},destroy:function(a){for(var b=0;b<tabs._state.tabs.length;b++)if(tabs._state.tabs[b].id==a)return tabs._state.tabs.remove(b),b;return!1},get:function(a){if(!a)return tabs._state.tabs;for(var b=0;b<tabs._state.tabs.length;b++)if(tabs._state.tabs[b].id==a)return tabs._state.tabs[b];return void 0},getIndex:function(a){for(var b=0;b<tabs._state.tabs.length;b++)if(tabs._state.tabs[b].id==a)return b;return-1},getSelected:function(){return tabs._state.selected},getAtIndex:function(a){return tabs._state.tabs[a]||void 0},setSelected:function(a){if(!tabs.get(a))throw new ReferenceError("Attempted to select a tab that does not exist.");tabs._state.selected=a},count:function(){return tabs._state.tabs.length}},tabActivity={minFadeAge:5e5,refresh:function(){var a=tabs.get(),b=tabs.getSelected(),c=(new Date).getTime();a.forEach(function(a){return b==a.id?void getTabElement(a.id).removeClass("fade"):void(c-a.lastActivity>tabActivity.minFadeAge?getTabElement(a.id).addClass("fade"):getTabElement(a.id).removeClass("fade"))})},init:function(){setInterval(tabActivity.refresh,7500)}};tabActivity.init();var tabGroup=$(".tab-group #tabs");$.fn.getInput=function(){return this.find(".tab-input")},addTab(),$(document.body).on("focus","webview",function(){leaveTabEditMode()}),ipc.on("zoomIn",function(){getWebview(tabs.getSelected())[0].send("zoomIn")}),ipc.on("zoomOut",function(){getWebview(tabs.getSelected())[0].send("zoomOut")}),ipc.on("zoomReset",function(){getWebview(tabs.getSelected())[0].send("zoomReset")}),ipc.on("print",function(){getWebview(tabs.getSelected())[0].print()}),ipc.on("inspectPage",function(){getWebview(tabs.getSelected())[0].openDevTools()}),ipc.on("addTab",function(a){addTab()}),ipc.on("addPrivateTab",function(a){var b=tabs.add({url:"about:blank","private":!0});addTab(b)});var Mousetrap=require("mousetrap");Mousetrap.bind(["command+l","command+k"],function(a){return enterEditMode(tabs.getSelected()),!1}),Mousetrap.bind("command+w",function(a){return a.preventDefault(),a.stopImmediatePropagation(),a.stopPropagation(),destroyTab(tabs.getSelected()),!1}),Mousetrap.bind("command+d",function(a){getTabElement(tabs.getSelected()).find(".bookmarks-button").click()}),Mousetrap.bind("command+f",function(a){findinpage.toggle()});for(var i=0;9>i;i++)!function(a){Mousetrap.bind("command+"+a,function(b){var c=tabs.getAtIndex(a-1);c&&switchToTab(c.id)})}(i);Mousetrap.bind("command+9",function(a){switchToTab(tabs.getAtIndex(tabs.count()-1).id);
}),Mousetrap.bind("esc",function(a){leaveTabEditMode()});var PDFViewerUrl="file://"+__dirname+"/pdfjs/web/viewer.html?url=";ipc.on("openPDF",function(a){var b=tabs.get(tabs.getSelected()),c=(getWebview(b.id),PDFViewerUrl+a.item.url);if(b.url!=c)if("about:blank"==b.url||b.url==a.item.url)navigate(tabs.getSelected(),c);else{var d=tabs.add({url:c});addTab(d,{focus:!1})}});var findinpage={container:$("#findinpage-bar"),input:$("#findinpage-bar .findinpage-input"),isEnabled:!1,start:function(a){findinpage.container.prop("hidden",!1),findinpage.isEnabled=!0,findinpage.input.focus().select()},end:function(a){findinpage.container.prop("hidden",!0),a&&0!=a.blurInput&&findinpage.input.blur(),findinpage.isEnabled=!1},toggle:function(){findinpage.isEnabled?findinpage.end():findinpage.start()},escape:function(a){return a.replace(/'/g,"\\'")}};findinpage.input.on("keyup",function(a){if(27==a.keyCode)return void findinpage.end();var b=findinpage.escape($(this).val());console.log(b),getWebview(tabs.getSelected())[0].executeJavaScript("find('{t}', false, false, true, false, false, false)".replace("{t}",b))}),findinpage.input.on("blur",function(a){findinpage.end({blurInput:!1})});var sessionRestore={save:function(){var a={version:1,tabs:tabs._state.tabs,selected:tabs._state.selected};localStorage.setItem("sessionrestoredata",JSON.stringify(a))},isRestorable:function(){return"{}"!=localStorage.getItem("sessionrestoredata")},restore:function(){var a=JSON.parse(localStorage.getItem("sessionrestoredata"));return tabs._state.tabs=[],$(".tab-item, webview").remove(),1==a.tabs.length&&"about:blank"==a.tabs[0].url?void addTab():(a.tabs.forEach(function(a,b){var c=tabs.add(a);addTab(c)}),switchToTab(a.selected),void setTimeout(function(){localStorage.setItem("sessionrestoredata","{}")},8e3))}};sessionRestore.isRestorable()&&sessionRestore.restore(),setInterval(sessionRestore.save,2e4);